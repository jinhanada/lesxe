# 2021-03-04


## macro

しばらくマクロの実験的な実装に取り掛かる。

expand-macroをCで書きたくなかったので、Lispでマクロシステムそのものを書けるようにしてみる。

現在は`%pre-eval`にprocが入っていたらeval前のコードをそれに食わせて評価、という方式。

ついでにhash-tableも実装してしまおう。マクロを登録するテーブルを作るために使う。

assocでもいいんだけど、hash-tableを作る動機を逃したくない。


## eval args

putc/getcの実装とともに、前々から気になっていたprimitive評価時の引数評価をまとめた。

現在の実装だとprimitive callの度に引数分リストが作られるので、GCの負荷が多分重くなる。

それを解消するにはスタックフレーム方式にしてin-placeで差し替えて行くのかな。phase2以降でやろう。


## GCとstack

evalIfに、GC用のスタック操作ミスによるバグがあった。

やっぱりCopyGCみたいなオブジェクトが動く系のGCはバグが起きやすいし、その挙動も珍妙なものになる。

今回は短いLispコードで発現したから早めに原因がわかってよかったけど、セルフコンパイルみたいな長いコードの最中で起きるとどうデバッグしていいか……。

早くConservativeGCの実装に取り掛かりたい。


## dict

hash取得できるようにして、mutableなhash-tableのdictを実装した。

しかし、REPLからの挙動がおかしい。多分Letのenvまわりを修正した余波じゃないかと思うけど、再現できないのでどうにも。