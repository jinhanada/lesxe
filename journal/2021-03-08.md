# 2021-03-08

## Tail Call Optimization

evalの内部でwhileループにすればいいんだけど、そのためにはenvを渡していくやりかたに変えないといけない。

whileループ内でletのenvを作った場合、letのbody最後の式はletのenvでかつループの最初に戻ってから評価することになる。現在だと`vm->env`を書き換えることになる。

そうすると、その最後の式の評価が終わったあとに元のenvに戻さないといけないわけで、無理やりやろうとするとかなり面倒な処理になる。envスタックを作って、while抜けるときは必ずgotoで後処理に飛ばしてスタックを戻す、みたいなやり方かな？あんまりよくない実装に思える。

じゃあCのコールスタックを使おう、ということでenvを渡していくやり方にするなら、envを扱うところ全てにPush/Popを新たに足すことになる。

それは流石に面倒なので、ConservativeGCを試すか、もう少しマシなポインタの管理を思いつくまで先延ばしにする。